name: CI/CD SSH Deploy

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: â¬‡ï¸ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ“¦ Install Composer Dependencies
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.3'
        tools: composer
      # Se requiere el build para asegurar que la carpeta /vendor estÃ© lista
    - run: composer install --prefer-dist --no-dev --optimize-autoloader
    
    # ğŸš€ Despliegue por SCP (Solo Transferencia de Archivos)
    - name: ğŸš€ 1. Transferencia de Archivos (SCP)
      uses: appleboy/scp-action@v0.1.7 # <-- USAR ESTA ACCIÃ“N PARA ARCHIVOS
      with:
        host: ${{ secrets.SSH_HOST }} 
        username: ${{ secrets.SSH_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ secrets.SSH_PORT }}
        source: "." 
        target: "${{ secrets.HOST_TARGET }}"

    # ğŸš€ EjecuciÃ³n de Drush (Control Total)
    - name: ğŸ”„ 2. Ejecutar Comandos Drush (SSH)
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ secrets.SSH_PORT }}
        script: |
          cd ${{ secrets.HOST_TARGET }}
          PHP_BIN="/usr/bin/php8.3" 
          $PHP_BIN vendor/bin/drush updb -y
          $PHP_BIN vendor/bin/drush cim -y
          $PHP_BIN vendor/bin/drush cr