name: CI/CD SSH Deploy

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: â¬‡ï¸ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ“¦ Install Composer Dependencies
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        tools: composer
      # Se requiere el build para asegurar que la carpeta /vendor estÃ© lista
    - run: composer install --prefer-dist --no-dev --optimize-autoloader
    
    # ğŸš€ Despliegue por SCP y EjecuciÃ³n de Drush (Control Total)
    - name: ğŸš€ SCP and SSH Deploy
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ secrets.SSH_PORT }}
        source: "."
        target: "${{ secrets.HOST_TARGET }}"
        script: |
          cd ${{ secrets.HOST_TARGET }}
          drush updb -y
          drush cim -y
          drush cr